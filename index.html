<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Map Pro - Traffic & Flood</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: 320px; background: #fff; border-right: 1px solid #ddd; padding: 15px; display: flex; flex-direction: column; gap: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000;}
        h2 { margin: 0 0 10px 0; color: #0056b3; font-size: 18px; }
        .box { background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; }
        .lbl { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        .row { display: flex; gap: 5px; margin-bottom: 5px; }
        input, select { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        button { padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-main { background: #28a745; color: white; width: 100%; font-weight: bold; }
        .btn-main:disabled { background: #ccc; }
        
        .mode-group { display: flex; gap: 0; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .mode-btn { flex: 1; background: #fff; border: none; border-right: 1px solid #ccc; padding: 8px; font-weight: 500; }
        .mode-btn:last-child { border-right: none; }
        .mode-btn.active { background: #007bff; color: white; }
        .mode-btn.active.traffic { background: #ffc107; color: black; }
        .mode-btn.active.forbidden { background: #343a40; color: white; }

        #trafficOptions { display: none; margin-top: 5px; }
        .status { padding: 8px; background: #e9ecef; border-radius: 4px; font-size: 12px; text-align: center; margin-top: auto;}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ—ºï¸ Smart Map Control</h2>

        <div class="box">
            <span class="lbl">ğŸ“ TÃ¬m Ä‘Æ°á»ng Ä‘i</span>
            <div class="row"><input id="startAddr" placeholder="Äiá»ƒm Ä‘i..."><button onclick="searchLoc('start')">ğŸ”</button></div>
            <div class="row"><input id="endAddr" placeholder="Äiá»ƒm Ä‘áº¿n..."><button onclick="searchLoc('end')">ğŸ”</button></div>
            <button id="findBtn" class="btn-main" onclick="findPath()" disabled>ğŸš€ TÃ¬m Ä‘Æ°á»ng tá»‘i Æ°u</button>
            <button onclick="resetPath()" style="width:100%; margin-top:5px; background:#6c757d; color:white;">ğŸ”„ Reset</button>
        </div>

        <div class="box" style="background: #fff3cd; border-color: #ffeeba;">
            <span class="lbl">ğŸ› ï¸ Cáº­p nháº­t giao thÃ´ng</span>
            <div class="mode-group">
                <button id="btnRoute" class="mode-btn active" onclick="setMode('route')">Xem</button>
                <button id="btnTraffic" class="mode-btn" onclick="setMode('traffic')">Táº¯c</button>
                <button id="btnForbidden" class="mode-btn" onclick="setMode('forbidden')">Cáº¥m</button>
            </div>
            <div id="trafficOptions">
                <select id="trafficLevel">
                    <option value="1">ğŸŸ¡ ÄÃ´ng (x1.2)</option>
                    <option value="2">ğŸŸ  Táº¯c vá»«a (x1.5)</option>
                    <option value="3">ğŸ”´ Táº¯c náº·ng (x2.0)</option>
                </select>
            </div>
            <div class="row" style="margin-top:10px;">
                <button onclick="clearData('traffic')" style="flex:1; background:#ffc107;">XÃ³a Táº¯c</button>
                <button onclick="clearData('forbidden')" style="flex:1; background:#343a40; color:white;">XÃ³a Cáº¥m</button>
            </div>
            <button onclick="toggleNodes()" style="width:100%; margin-top:5px; background:#17a2b8; color:white;">ğŸ”˜ Hiá»‡n/áº¨n NÃºt giao</button>
        </div>

        <div class="box" style="background: #e3f2fd; border-color: #bbdefb;">
            <span class="lbl">â˜” MÆ°a & Ngáº­p lá»¥t</span>
            <div class="row">
                <input type="number" id="rainInput" value="0" placeholder="mm">
                <button onclick="setRain()" style="background:#0277bd; color:white;">Cáº­p nháº­t</button>
            </div>
            <button onclick="showFloodedRoads()" style="width:100%; margin-top:5px; background:#0288d1; color:white;">ğŸ‘ï¸ Hiá»‡n Ä‘Æ°á»ng ngáº­p</button>
        </div>

        <div class="status" id="status">Sáºµn sÃ ng.</div>
    </div>
    
    <div id="map" style="flex-grow: 1;"></div>

    <script>
        const map = L.map('map').setView([20.9764, 105.8556], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- Äá»ŠNH NGHÄ¨A ICON MÃ€U ---
        // 1. Icon Äá» (DÃ¹ng cho Táº¯c Ä‘Æ°á»ng)
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // 2. Icon Äen (DÃ¹ng cho Cáº¥m Ä‘Æ°á»ng)
        const blackIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        // --------------------------------------------------

        let startMarker, endMarker, pathLayer;
        let trafficLayer = L.layerGroup().addTo(map);
        let forbiddenLayer = L.layerGroup().addTo(map);
        let floodLayer = L.layerGroup().addTo(map);
        let nodeLayer = L.layerGroup().addTo(map);
        let isNodeVisible = false;

        let mode = 'route'; 
        let tempStart = null, tempMarker = null;
        let routeStep = 'start';

        const statusEl = document.getElementById('status');
        const findBtn = document.getElementById('findBtn');
        const mapContainer = document.getElementById('map');

        map.on('click', e => {
            if (mode === 'route') handleRouteClick(e.latlng);
            else handleSegmentClick(e.latlng);
        });

        // --- Xá»¬ LÃ NODE ---
        async function toggleNodes() {
            if (isNodeVisible) {
                nodeLayer.clearLayers();
                isNodeVisible = false;
                statusEl.textContent = "ÄÃ£ áº©n nÃºt giao.";
                return;
            }
            statusEl.textContent = "Äang táº£i nodes...";
            try {
                const res = await fetch('http://localhost:5000/api/get-nodes');
                const d = await res.json();
                if (d.status === 'success') {
                    d.nodes.forEach(n => {
                        L.circleMarker([n.lat, n.lng], {
                            radius: 3, color: '#444', fillColor: '#888', fillOpacity: 0.8, weight: 1
                        }).addTo(nodeLayer);
                    });
                    isNodeVisible = true;
                    statusEl.textContent = `ÄÃ£ hiá»‡n ${d.nodes.length} nÃºt giao.`;
                }
            } catch (e) { console.error(e); statusEl.textContent = "Lá»—i táº£i nodes!"; }
        }

        // --- Xá»¬ LÃ GIAO THÃ”NG (Traffic/Forbidden) ---
        function handleSegmentClick(latlng) {
            if (!tempStart) {
                // Chá»n Ä‘iá»ƒm Ä‘áº§u tiÃªn
                tempStart = latlng;
                
                // --- LOGIC CHá»ŒN MÃ€U PIN ---
                let iconToUse;
                let modeText;
                
                if (mode === 'traffic') {
                    iconToUse = redIcon;    // Táº¯c -> Äá»
                    modeText = "Táº¯c";
                } else {
                    iconToUse = blackIcon;  // Cáº¥m -> Äen
                    modeText = "Cáº¥m";
                }

                tempMarker = L.marker(latlng, { icon: iconToUse, opacity: 0.9 }).addTo(map);
                tempMarker.bindPopup(`Äiá»ƒm Äáº¦U (${modeText})`).openPopup();
                // --------------------------------------------------------------
                
                statusEl.textContent = `ÄÃ£ chá»n Äáº¦U (${modeText}). HÃ£y chá»n Ä‘iá»ƒm CUá»I!`;
            } else {
                // Chá»n Ä‘iá»ƒm thá»© hai vÃ  gá»­i dá»¯ liá»‡u
                const p1 = tempStart;
                const p2 = latlng;
                map.removeLayer(tempMarker); // XÃ³a marker táº¡m
                tempStart = null; tempMarker = null;
                sendSegmentData(p1, p2);
            }
        }

        async function sendSegmentData(p1, p2) {
            statusEl.textContent = "Äang xá»­ lÃ½...";
            const level = document.getElementById('trafficLevel').value;
            try {
                const res = await fetch('http://localhost:5000/api/add-segment', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ p1, p2, mode, level })
                });
                const d = await res.json();
                if (d.status === 'success') {
                    statusEl.textContent = d.message;
                    L.polyline(d.path, { color: d.color, weight: 6, opacity: 0.8 }).addTo(mode==='traffic'?trafficLayer:forbiddenLayer);
                } else alert(d.message);
            } catch (e) { console.error(e); }
        }

        // --- Xá»¬ LÃ MÆ¯A & NGáº¬P ---
        async function setRain() {
            const r = document.getElementById('rainInput').value;
            await fetch('http://localhost:5000/api/set-rain', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({rain: r})
            });
            statusEl.textContent = `ÄÃ£ cáº­p nháº­t mÆ°a: ${r}mm`;
            floodLayer.clearLayers();
        }

        async function showFloodedRoads() {
            statusEl.textContent = "Äang táº£i dá»¯ liá»‡u ngáº­p...";
            try {
                const res = await fetch('http://localhost:5000/api/get-flooded-roads');
                const d = await res.json();
                floodLayer.clearLayers();
                if (d.roads && d.roads.length > 0) {
                    d.roads.forEach(line => {
                        L.polyline(line, { color: '#00BFFF', weight: 5, dashArray: '10, 10', opacity: 0.8 }).addTo(floodLayer);
                    });
                    statusEl.textContent = `Hiá»‡n ${d.roads.length} Ä‘oáº¡n Ä‘Æ°á»ng ngáº­p (MÆ°a: ${d.rain}mm).`;
                } else { statusEl.textContent = "KhÃ´ng cÃ³ Ä‘oáº¡n nÃ o bá»‹ ngáº­p."; }
            } catch (e) { console.error(e); statusEl.textContent = "Lá»—i táº£i dá»¯ liá»‡u ngáº­p!"; }
        }

        // --- TÃŒM ÄÆ¯á»œNG (Váº«n dÃ¹ng marker xanh máº·c Ä‘á»‹nh) ---
        function handleRouteClick(ll) {
            if (routeStep === 'start') {
                if(startMarker) map.removeLayer(startMarker);
                // Marker máº·c Ä‘á»‹nh mÃ u xanh
                startMarker = L.marker(ll).addTo(map).bindPopup("A (Äiá»ƒm Ä‘i)").openPopup();
                document.getElementById('startAddr').value = `${ll.lat.toFixed(4)}, ${ll.lng.toFixed(4)}`;
                routeStep = 'end';
            } else {
                if(endMarker) map.removeLayer(endMarker);
                // Marker máº·c Ä‘á»‹nh mÃ u xanh
                endMarker = L.marker(ll).addTo(map).bindPopup("B (Äiá»ƒm Ä‘áº¿n)").openPopup();
                document.getElementById('endAddr').value = `${ll.lat.toFixed(4)}, ${ll.lng.toFixed(4)}`;
                routeStep = 'start';
                findBtn.disabled = false;
            }
        }

        async function findPath() {
            if(!startMarker || !endMarker) return;
            statusEl.textContent = "Äang tÃ¬m Ä‘Æ°á»ng...";
            const start = startMarker.getLatLng(), end = endMarker.getLatLng();
            const res = await fetch('http://localhost:5000/api/find-path', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({start, end})
            });
            const d = await res.json();
            if(pathLayer) map.removeLayer(pathLayer);
            if(d.status === 'success') {
                pathLayer = L.polyline(d.path, {color: 'blue', weight: 6}).addTo(map);
                statusEl.textContent = "ÄÃ£ tÃ¬m tháº¥y Ä‘Æ°á»ng.";
            } else statusEl.textContent = "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ°á»ng (Táº¯c/Ngáº­p)!";
        }

        // --- HÃ€M SET MODE ---
        function setMode(m) {
            mode = m; tempStart = null; if(tempMarker) map.removeLayer(tempMarker);
            
            // UI Button State
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active', 'traffic', 'forbidden'));
            const btn = document.getElementById(m==='route'?'btnRoute':(m==='traffic'?'btnTraffic':'btnForbidden'));
            btn.classList.add('active'); if(m!=='route') btn.classList.add(m);
            document.getElementById('trafficOptions').style.display = m==='traffic'?'block':'none';

            statusEl.textContent = m === 'route' ? "Cháº¿ Ä‘á»™ TÃ¬m Ä‘Æ°á»ng." : `Cháº¿ Ä‘á»™ chá»n Ä‘Æ°á»ng ${m === 'traffic' ? 'Táº¯c' : 'Cáº¥m'}. Click lÃªn báº£n Ä‘á»“ Ä‘á»ƒ chá»n 2 Ä‘iá»ƒm.`;
        }

        async function clearData(type) {
            if(confirm('XÃ³a dá»¯ liá»‡u nÃ y?')) {
                await fetch('http://localhost:5000/api/clear-data', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({target: type})
                });
                (type==='traffic'?trafficLayer:forbiddenLayer).clearLayers();
            }
        }
        function resetPath() {
            if(pathLayer) map.removeLayer(pathLayer);
            if(startMarker) map.removeLayer(startMarker);
            if(endMarker) map.removeLayer(endMarker);
            startMarker=null; endMarker=null; pathLayer=null; findBtn.disabled=true;
        }
    </script>
</body>
</html>
